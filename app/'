import { Box, Grid, Typography } from '@mui/material';
import CustomTextField from 'components/fields/CustomTextField';
import TelemetrySelectField from 'components/fields/TelemetrySelectField';
import FormikDevDebugger from 'components/formik/FormikDevDebugger';
import { AttachmentType } from 'constants/attachments';
import { DialogContext } from 'contexts/dialogContext';
import { SurveyContext } from 'contexts/surveyContext';
import { Field, useFormikContext } from 'formik';
import { useBiohubApi } from 'hooks/useBioHubApi';
import { useQuery } from 'hooks/useQuery';
import { useTelemetryApi } from 'hooks/useTelemetryApi';
import { useContext } from 'react';
import { setMessageSnackbar } from 'utils/Utils';
import { ANIMAL_FORM_MODE, IAnimal } from '../animal';
import { DeploymentFormSection } from './DeploymentFormSection';
import TelemetryFileUpload from './TelemetryFileUpload';

interface telemetryDeviceFormContentProps {
  index: number;
  mode: ANIMAL_FORM_MODE;
}
const TelemetryDeviceFormContent = (props: telemetryDeviceFormContentProps) => {
  const { index, mode } = props;

  const bhApi = useBiohubApi();
  const api = useTelemetryApi();
  const { cid: survey_critter_id } = useQuery();
  const { values, handleBlur } = useFormikContext<IAnimal>();
  const { surveyId, projectId } = useContext(SurveyContext);
  const dialogContext = useContext(DialogContext);

  const device = values.device?.[index];

  //const { data: bctwDeviceData, refresh } = useDataLoader(() => api.devices.getDeviceDetails(device.device_id));

  const handleRemoveDeployment = async (deployment_id: string) => {
    try {
      if (survey_critter_id === undefined) {
        setMessageSnackbar('No critter set!', dialogContext);
      }
      await bhApi.survey.removeDeployment(projectId, surveyId, Number(survey_critter_id), deployment_id);
      //refresh();
      const deployments = values.device[index].deployments;
      const indexOfDeployment = deployments?.findIndex((deployment) => deployment.deployment_id === deployment_id);
      if (indexOfDeployment !== undefined) {
        deployments?.splice(indexOfDeployment);
      }
      setMessageSnackbar('Deployment deleted', dialogContext);
    } catch (e) {
      setMessageSnackbar('Failed to delete deployment.', dialogContext);
    }
  };

  if (!device) {
    return <></>;
  }

  const validateDeviceID = (value: number | '') => {
    console.log('validating');
    if (value) {
      return 'error';
    }
  };

  return (
    <>
      <Box component="fieldset">
        <Typography component="legend" variant="body2">
          Device Metadata
        </Typography>
        <Grid container spacing={3}>
          <Grid item xs={6}>
            <Field
              as={CustomTextField}
              label="Device ID"
              name={`device.${index}.device_id`}
              other={{ disabled: mode === ANIMAL_FORM_MODE.EDIT }}
              validate={validateDeviceID}
              handleBlur={handleBlur}
            />
          </Grid>
          <Grid item xs={6}>
            <Grid container>
              <Grid
                item
                xs={8}
                sx={{
                  '& .MuiInputBase-root': {
                    borderTopRightRadius: 0,
                    borderBottomRightRadius: 0
                  }
                }}>
                <CustomTextField label="Frequency (Optional)" name={`device.${index}.frequency`} />
              </Grid>
              <Grid
                item
                xs={4}
                sx={{
                  '& .MuiInputBase-root': {
                    ml: '-1px',
                    borderTopLeftRadius: 0,
                    borderBottomLeftRadius: 0
                  }
                }}>
                <TelemetrySelectField
                  label="Units"
                  name={`device.${index}.frequency_unit`}
                  id="frequency_unit"
                  fetchData={async () => {
                    const codeVals = await api.devices.getCodeValues('frequency_unit');
                    return codeVals.map((a) => a.description);
                  }}
                />
              </Grid>
            </Grid>
          </Grid>
          <Grid item xs={6}>
            <TelemetrySelectField
              label="Device Manufacturer"
              name={`device.${index}.device_make`}
              id="manufacturer"
              fetchData={api.devices.getCollarVendors}
              controlProps={{ disabled: mode === ANIMAL_FORM_MODE.EDIT }}
            />
          </Grid>
          <Grid item xs={6}>
            <CustomTextField label="Device Model (Optional)" name={`device.${index}.device_model`} />
          </Grid>
        </Grid>
      </Box>
      {((device.device_make === 'Vectronic' && !bctwDeviceData?.keyXStatus) || device.device_make === 'Lotek') && (
        <Box sx={{ mt: 3 }}>
          <Typography component="legend" variant="body2">
            Upload Attachment
          </Typography>
          {device.device_make === 'Vectronic' && (
            <>
              <Typography
                variant="body1"
                color="textSecondary"
                sx={{
                  mt: -1,
                  mb: 3
                }}>{`Vectronic KeyX File (Optional)`}</Typography>
              <TelemetryFileUpload attachmentType={AttachmentType.KEYX} index={index} />
            </>
          )}
          {device.device_make === 'Lotek' && (
            <>
              <Typography
                variant="body1"
                color="textSecondary"
                sx={{
                  mt: -1,
                  mb: 3
                }}>{`Lotek Config File (Optional)`}</Typography>
              <TelemetryFileUpload attachmentType={AttachmentType.OTHER} index={index} />
            </>
          )}
        </Box>
      )}
      <Box component="fieldset" sx={{ mt: 3 }}>
        <Typography component="legend" variant="body2">
          Deployments
        </Typography>
        <DeploymentFormSection mode={mode} handleRemoveDeployment={handleRemoveDeployment} index={index} />
      </Box>
      <FormikDevDebugger />
    </>
  );
};

export default TelemetryDeviceFormContent;
